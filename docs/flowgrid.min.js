!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.flowgrid=e()}(this,function(){"use strict";function t(t,e,n){Array.isArray(t)&&void 0===n&&(n=t,t=void 0),this.init(t,e,n)}function e(e,n,a){d.init(!0,document.body),n?"object"===("undefined"==typeof jQuery?"undefined":h(jQuery))&&n instanceof jQuery&&(n=n[0]):n=document.querySelector("."+i.FG_LAYOUT);var r=++c.count;return n.getAttribute(i.FG_LAYOUT_INDEX)||n.setAttribute(i.FG_LAYOUT_INDEX,r),c[r]=new t(e,n,a),c[r]}function n(t){delete c[t.opt.container.getAttribute(i.FG_LAYOUT_INDEX)],t.destroy(),t=null}var i={THROTTLE_TIME:14,MEDIA_QUERY_SMALL:768,MEDIA_QUERY_MID:992,MEDIA_QUERY_BIG:1200,FG_CONTAINER:"fg-container",FG_LAYOUT:"fg-layout",FG_LAYOUT_DRAGGABLE:"data-fg-draggable",FG_LAYOUT_RESIZABLE:"data-fg-resizable",FG_LAYOUT_INDEX:"data-fg-index",FG_ITEM:"fg-item",FG_ITEM_ANIMATE:"fg-item-animate",FG_ITEM_CONTENT:"fg-item-content",FG_ITEM_ZOOM_BAR:"fg-zoom-bar",FG_ITEM_ZOOM_BAR_ICO:"fg-zoom-bar-ico",FG_ITEM_DRAG_BAR:"fg-drag-bar",FG_ITEM_DRAG_BAR_ICO:"fg-drag-bar-ico",FG_ITEM_GRAG_DROP:"fg-item-dragdrop",FG_ITEM_PLACEHOLDER:"fg-item-placeholder",FG_ITEM_DATA_ID:"data-fg-id",PLACEHOLDER:"placeholder"},a=function(){},r={className:"",row:7,col:12,container:null,distance:5,draggable:!0,resizable:!0,isDragBar:!1,nodeMinW:2,nodeMinH:2,overflow:5,padding:{top:5,left:5,right:5,bottom:5},cellScale:{w:16,h:9},autoAddCell:{x:0,y:0,w:2,h:2},onDragStart:a,onDragEnd:a,onResizeStart:a,onResizeEnd:a,onAddNode:a,onDeleteNode:a,onLoad:a};t.prototype={constructor:t,init:function(t,e,n){var i=l.extend(r,t);if(this.originalData=[],this.area=[],this.data=[],this.elements={},this.opt=i,this.opt.container=e,this.computeCellScale(i),n)this.setData(n);else{var a=o.dom2obj(e,this);a&&a.length>0&&this.setData(a)}return this},destroy:function(){return this.originalData=null,this.opt=null,this.area=null,this.data=null,this.elements=null,this},clean:function(){return this.originalData=[],this.area=[],this.data=[],this.elements={},this},loadDom:function(t){if(void 0===t||!0===t){this.originalData=[],this.area=[],this.data=[],this.elements={};var e=o.dom2obj(this.opt.container,this);e&&e.length>0&&this.setData(e)}return this},load:function(t){if(void 0===t||!0===t){var e=this,n=this.opt,i=this.area,a=this.data,r=this.elements,s=this.getMaxRowAndCol(n,a);o.setContainerAttr(n.container,n,n.draggable,n.draggable),this.sortData(a).buildArea(i,s.row,s.col).putData(i,a).layout(i,a),o.render(a,r,n.container,this),l.callbackFun(function(){e.opt.onLoad&&e.opt.onLoad()})}return this},resize:function(t,e){var n=this.opt;n.container;this.computeCellScale(n),this.load()},computeCellScale:function(t){return t.containerW=t.container.clientWidth,t.containerH=t.container.clientHeight,t.cellW=t.containerW/t.col,t.cellH=t.cellW/t.cellScale.w*t.cellScale.h,t.cellW_Int=Math.floor(t.cellW),t.cellH_Int=Math.floor(t.cellH),this},setData:function(t,e){if(t&&Array.isArray(t)){this.originalData=t;var n=this.opt,i=this.data=[];t.forEach(function(t,e){i[e]=l.buildNode(t,e,n)}),this.load(e)}return this},sortData:function(t){return t.sort(function(t,e){var n=t.y-e.y;return 0===n?t.x-e.x:n}),this},buildArea:function(t,e,n){if(t&&Array.isArray(t))for(var i=0;i<e;i++)t[i]=new Array(n);return this},putData:function(t,e){var n,i,a,r,o,s,d;for(n=0,r=e.length;n<r;n++)for(i=(d=e[n]).y,o=d.y+d.h;i<o;i++)for(a=d.x,s=d.x+d.w;a<s;a++)t[i][a]=d.id;return this},getMaxRowAndCol:function(t,e){var n,i,a,t=t||this.opt,e=e||this.data,r={row:t.row,col:t.col};if(e&&e.length>0)for(n=0,a=e.length;n<a;n++)(i=e[n]).y+i.h>r.row&&(r.row=i.y+i.h),i.x+i.w>r.col&&(r.col=i.x+i.w);return r},add:function(t,e){var n=this,i=this.opt,a=this.area,r=this.data;if(t)o=l.buildNode(t,t.id||r.length,i),this.checkIndexIsOutOf(a,o),this.overlap(r,o);else{var o=l.buildNode(i.autoAddCell,r.length,i);o=this.addAutoNode(a,o)}return r[r.length]=o,this.load(e),l.callbackFun(function(){n.opt.onAddNode&&n.opt.onAddNode(n.elements[o.id],o)}),o},getVacant:function(t,e){return this.addAutoNode(this.area,this.data,{x:0,y:0,w:t,h:e})},addAutoNode:function(t,e,n){if(0===e.length)return n;var i,a,r=t[0].length;for(i=0;i<t.length;i+=1)for(n.y=i,a=0;a<t[0].length;a+=1)if(n.x=a,n.x+n.w>r&&(n.x=0),!this.collision(t,n))return n;return n.x=0,n.y=i,n},collision:function(t,e){var n,i,a,r;for(n=e.y,a=e.y+e.h;n<a;n++)for(i=e.x,r=e.x+e.w;i<r;i++)if(t[n]&&(t[n][i]||0==t[n][i]))return!0;return!1},delete:function(t,e){var n=this,i=this.data,a=this.area,r=this.query(t),s=r.index,d=r.node,c=i.splice(s,1);return o.remove(t),delete this.elements[t],this.replaceNodeInArea(a,d).load(e),l.callbackFun(function(){n.opt.onDeleteNode&&n.opt.onDeleteNode(n.elements[t],c[0])}),c[0]},edit:function(t,e){var n=this.query(t.id).node;for(var i in t)n[i]=t[i];return this.load(e),n},query:function(t){for(var e=this.data,n=0,i=e.length;n<i;n++)if(e[n].id==t)return{index:n,node:e[n]}},setDraggable:function(t){var e=this.opt;return o.setContainerAttr(e.container,e,t,void 0),this},setResizable:function(t){var e=this.opt;return o.setContainerAttr(e.container,e,void 0,t),this},checkIndexIsOutOf:function(t,e,n){t.length;var i=t[0]&&t[0].length||this.opt.col;return e.x<0&&(e.x=0),e.y<0&&(e.y=0),n?e.x+e.w>i&&(e.w=i-e.x):e.x+e.w>i&&(e.x=i-e.w),this},checkHit:function(t,e){var n=!1;return t.x+t.w>e.x&&t.x<e.x+e.w&&t.y+t.h>e.y&&t.y<e.y+e.h&&(n=!0),n},overlap:function(t,e,n,i,a){var r,o,s,n=n||0,i=i||0,d=null,l=0,c=0,a=a||!1,h=this.checkHit;if(!a){for(r=0,s=t.length;r<s;r++)(o=t[r])!==e&&h(o,e)&&(f=o.y+o.h-e.y)>l&&(l=f,d=o);if(d){var u=d.h/2<1?1:Math.floor(d.h/2);(i>=2&&i>=n?e.y+e.h-d.y:e.y-d.y)>=u&&(e.y=e.y+l)}}for(r=0,s=t.length;r<s;r++)if((o=t[r])!==e&&h(o,e)){var f=e.y-o.y;c=f>c?f:c}for(r=0,s=t.length;r<s;r++)(o=t[r])!==e&&(o.y<e.y&&e.y<o.y+o.h||e.y<=o.y)&&(o.y=o.y+e.h+c);return this},layout:function(t,e){var n,i,a,r;for(n=0,i=e.length;n<i;n++)r=e[n],a=this.findEmptyLine(t,r),r.y>a&&this.moveUp(t,r,a);return this},findEmptyLine:function(t,e){var n,i,a,r;for(n=e.y-1;n>=0;n--)for(i=e.x,a=e.x+e.w;i<a;i++)if((r=t[n][i])||0==r)return n+1;return 0},moveUp:function(t,e,n){this.replaceNodeInArea(t,e);var i,a,r,o;for(e.y=n,i=e.y,r=e.y+e.h;i<r;i++)for(a=e.x,o=e.x+e.w;a<o;a++)t[i][a]=e.id},replaceNodeInArea:function(t,e,n){var i,a,r,o;for(i=e.y,r=e.y+e.h;i<r;i++)for(a=e.x,o=e.x+e.w;a<o;a++)t[i]&&(t[i][a]=n);return this},clone:function(t){var e={};for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}};var o={dom2obj:function(t,e){var n,a,r,o=[],s=t.children;for(n=0,a=s.length;n<a;n++)if((r=s[n]).classList.contains(i.FG_ITEM)){o[n]={x:1*r.getAttribute("data-fg-x"),y:1*r.getAttribute("data-fg-y"),w:1*r.getAttribute("data-fg-w"),h:1*r.getAttribute("data-fg-h"),minW:1*r.getAttribute("data-fg-min-w"),minH:1*r.getAttribute("data-fg-min-h")};var d=r.getAttribute("data-fg-id");d?(o[n].id=d,e.elements[d]=r):e.elements[n]=r}return o},setContainerAttr:function(t,e,n,a){t&&(void 0!==n&&(e.draggable=!!n,e.container.setAttribute(i.FG_LAYOUT_DRAGGABLE,e.draggable)),void 0!==a&&(e.resizable=!!a,e.container.setAttribute(i.FG_LAYOUT_RESIZABLE,e.resizable)))},getOffset:function(t,e){return e=e||{top:0,left:0},null===t||t===document?e:(e.top+=t.offsetTop,e.left+=t.offsetLeft,this.getOffset(t.offsetParent,e))},searchUp:function(t,e){if(t!==document.body&&t!==document)return t.classList.contains(e)?t:this.searchUp(t.parentNode,e)},create:function(t,e,n){var a=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div");if(t.opt.isDragBar){var s=document.createElement("div");s.className=i.FG_ITEM_DRAG_BAR,s.innerHTML='<svg class="'+i.FG_ITEM_DRAG_BAR_ICO+'" viewBox="0 0 200 200"version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g class="transform-group"><g transform="scale(0.1953125, 0.1953125)"><path d="M 839.457 330.079 c 36.379 0 181.921 145.538 181.921 181.926 c 0 36.379 -145.543 181.916 -181.921 181.916 c -36.382 0 -36.382 -36.388 -36.382 -36.388 v -291.07 c 0 0 0 -36.384 36.382 -36.384 v 0 Z M 803.058 475.617 v 72.766 l -254.687 -0.001 v 254.692 h -72.766 v -254.691 h -254.683 v -72.766 h 254.682 v -254.693 h 72.766 v 254.692 l 254.688 0.001 Z M 693.921 184.546 c 0 36.377 -36.388 36.377 -36.388 36.377 h -291.07 c 0 0 -36.383 0 -36.383 -36.377 c 0 -36.387 145.538 -181.926 181.926 -181.926 c 36.375 0 181.915 145.539 181.915 181.926 v 0 Z M 657.531 803.075 c 0 0 36.388 0 36.388 36.382 c 0 36.388 -145.538 181.921 -181.916 181.921 c -36.387 0 -181.926 -145.532 -181.926 -181.921 c 0 -36.382 36.383 -36.382 36.383 -36.382 h 291.07 Z M 220.924 548.383 v 109.149 c 0 0 0 36.388 -36.377 36.388 c -36.387 0 -181.926 -145.538 -181.926 -181.916 c 0 -36.387 145.538 -181.926 181.926 -181.926 c 36.377 0 36.377 36.383 36.377 36.383 v 181.92 Z M 220.924 548.383 Z"></path></g></g></svg>',a.appendChild(s)}return a.className=n||i.FG_ITEM+" "+i.FG_ITEM_ANIMATE,r.className=i.FG_ITEM_ZOOM_BAR,o.className=i.FG_ITEM_CONTENT,a.appendChild(o),a.appendChild(r),this.update(t,a,e,n),a},update:function(t,e,n,a){var r=t.opt;e&&(e.className=a||i.FG_ITEM+" "+i.FG_ITEM_ANIMATE,e.setAttribute(i.FG_ITEM_DATA_ID,n.id),e.setAttribute("data-fg-x",n.x),e.setAttribute("data-fg-y",n.y),e.setAttribute("data-fg-w",n.w),e.setAttribute("data-fg-h",n.h),e.style.cssText+=";transform: translate("+n.x*r.cellW_Int+"px,"+n.y*r.cellH_Int+"px);width: "+(n.w*r.cellW_Int-r.padding.left-r.padding.right)+"px;height: "+(n.h*r.cellH_Int-r.padding.top-r.padding.bottom)+"px;")},clear:function(t){t.innerHTML=""},remove:function(t){var e=document.querySelector("div."+i.FG_ITEM+"["+i.FG_ITEM_DATA_ID+'="'+t+'"]');e&&e.parentNode.removeChild(e)},render:function(t,e,n,i){var a,r,o,s;if(l.isEmptyObject(e)){var d=document.createDocumentFragment();for(a=0,r=t.length;a<r;a++)(o=t[a])&&(s=e[o.id]=this.create(i,o),d.appendChild(s));n.appendChild(d)}else for(a=0,r=t.length;a<r;a++)(o=t[a])&&(e[o.id]?this.update(i,e[o.id],o):(s=e[o.id]=this.create(i,o),n.appendChild(s)))}},s={isDrag:!1,isResize:!1,dragNode:{id:void 0,node:null},dragElement:null,dragstart:function(t,e){var n=t.target.classList,a=this.flowgrid=c.get(e);if(a.opt.draggable){if(!n.contains(i.FG_ITEM_DRAG_BAR))if(n.contains(i.FG_ITEM_ZOOM_BAR))this.isResize=!0;else if(a.opt.isDragBar)return;this.isDrag=!0,this.dragElement=e;var r=a.query(e.getAttribute(i.FG_ITEM_DATA_ID));if(r){this.dragElement.className=i.FG_ITEM+" "+i.FG_ITEM_GRAG_DROP,this.dragNode.id=r.node.id,this.dragNode.node=r.node,this.dragNode.node.id=i.PLACEHOLDER;var s=a.elements[this.dragNode.node.id]=o.create(a,this.dragNode.node);a.opt.container.appendChild(s)}}},drag:function(t){if(this.dragNode.node){var e=this.flowgrid,n=e.opt,i=n.container,a=o.getOffset(i),r=this.dragElement.style.transform.replace(/translate.*\(/gi,"").replace(/\).*$/gi,"").replace(/px/gi,"").split(","),s={containerX:a.left,containerY:a.top,containerW:i.clientWidth,translateX:1*r[0],translateY:1*r[1]};this.prevX||(this.prevX=t.pageX),this.prevY||(this.prevY=t.pageY),s.dx=t.pageX-this.prevX,s.dy=t.pageY-this.prevY,this.prevX=t.pageX,this.prevY=t.pageY,s.eventX=t.pageX-s.containerX,s.eventY=t.pageY-s.containerY,this.isResize?this.resize(t,n,s,e):(this.eventOffsetX||(this.eventOffsetX=s.eventX-s.translateX),this.eventOffsetY||(this.eventOffsetY=s.eventY-s.translateY),this.changeLocation(t,n,s,e))}},changeLocation:function(t,e,n,i){var a=this.dragNode.node,r=n.eventX-this.eventOffsetX,o=n.eventY-this.eventOffsetY;this.dragElement.style.cssText+=";transform: translate("+r+"px,"+o+"px);";var s=Math.round(r/e.cellW_Int),d=Math.round(o/e.cellH_Int);a.x===s&&a.y===d||(i.replaceNodeInArea(i.area,a),a.x=s,a.y=d,i.checkIndexIsOutOf(i.area,a,this.isResize),i.overlap(i.data,a,n.dx,n.dy,this.isResize),i.load())},resize:function(t,e,n,i){var a=this.dragNode.node,r=a.minW*e.cellW_Int-e.padding.left-e.padding.right,o=a.minH*e.cellH_Int-e.padding.top-e.padding.bottom,s=n.eventX-n.translateX+e.overflow,d=n.eventY-n.translateY+e.overflow,l=s,c=d;s<r&&(l=r-e.overflow),d<o&&(c=o-e.overflow),s+n.translateX>n.containerW&&(l=n.containerW-n.translateX+e.overflow),this.dragElement.style.cssText+=";width: "+l+"px; height: "+c+"px;";var h=Math.ceil(l/e.cellW_Int),u=Math.ceil(c/e.cellH_Int);a.w===h&&a.h===u||(i.replaceNodeInArea(i.area,a),a.w=h,a.h=u,i.checkIndexIsOutOf(i.area,a,this.isResize),i.overlap(i.data,a,n.dx,n.dy,this.isResize),i.load())},dragend:function(t){if(this.dragNode.node){var e=this.flowgrid,n=this.dragNode.node;n.id=this.dragNode.id,o.update(e,e.elements[n.id],n),this.dragElement.className=i.FG_ITEM+" "+i.FG_ITEM_ANIMATE,this.flowgrid=null,this.isDrag=!1,this.isResize=!1,this.dragNode.id=void 0,this.dragNode.node=null,this.prevX=void 0,this.prevY=void 0,this.eventOffsetX=void 0,this.eventOffsetY=void 0,o.remove(i.PLACEHOLDER),delete e.elements[i.PLACEHOLDER]}}},d={init:function(t){this.isbind||(this.isbind=t,this.unbindEvent(),this.bindEvent())},bindEvent:function(){document.addEventListener("mousedown",this.mousedown,!1),document.addEventListener("mousemove",this.mousemove,!1),document.addEventListener("mouseup",this.mouseup,!1),document.addEventListener("click",this.click,!0),this.isbind=!0},unbindEvent:function(){document.removeEventListener("mousedown",this.mousedown,!1),document.removeEventListener("mousemove",this.mousemove,!1),document.removeEventListener("mouseup",this.mouseup,!1),document.removeEventListener("click",this.click,!0),this.isbind=!1},mousedown:function(t){var e=this.node=o.searchUp(t.target,i.FG_ITEM);if(e){s.dragstart(t,e);var n=s.isResize,a=s.flowgrid;this.distance=a.opt.distance,this.pageX=t.pageX,this.pageY=t.pageY,a.opt.draggable&&l.callbackFun(function(){n?a.opt.onResizeStart(t,s.dragElement,s.dragNode):a.opt.onDragStart(t,s.dragElement,s.dragNode)})}},mousemove:function(t){if(s.isDrag){var e=Math.abs(t.pageX-this.pageX),n=Math.abs(t.pageY-this.pageY);this.triggerDistance=!!this.distance&&(e>=this.distance||n>=this.distance),(this.triggerDistance||s.isResize)&&l.throttle((new Date).getTime())&&s.drag(t)}},mouseup:function(t){if(s.isDrag){var e=this.triggerDistance,n=s.isResize,i=s.flowgrid,a=i.clone(s.dragNode);l.callbackFun(function(){e&&(n?i.opt.onResizeEnd(t,s.dragElement,a):i.opt.onDragEnd(t,s.dragElement,a))}),s.dragend(t),this.triggerDistance=!1}},click:function(t){if(this.node){var e=Math.abs(t.pageX-this.pageX),n=Math.abs(t.pageY-this.pageY);(e>=this.distance||n>=this.distance)&&t.stopPropagation(),this.node=null}}},l={extend:function(t,e){if(!e)return t;var n={};for(var i in t)void 0!==e[i]?n[i]=e[i]:n[i]=t[i];return n},isEmptyObject:function(t){for(var e in t)return!1;return!0},throttle:function(t){var e=(new Date).getTime();this.throttle=function(t){return t-e>i.THROTTLE_TIME&&(e=t,!0)},this.throttle(t)},callbackFun:function(t){try{"function"==typeof t&&t()}catch(t){throw new Error("flowgrid callback exception:"+t)}},buildNode:function(t,e,n){return{id:t.id||e,x:t.x,y:t.y,w:t.w||t.minW||n.nodeMinW,h:t.h||t.minH||n.nodeMinH,minW:t.minW||n.nodeMinW,minH:t.minH||n.nodeMinH}}},c={count:0,get:function(t){var e=o.searchUp(t,i.FG_LAYOUT);return c[e.getAttribute(i.FG_LAYOUT_INDEX)]}},h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};return{version:"1.2.1",instance:e,destroy:n}});